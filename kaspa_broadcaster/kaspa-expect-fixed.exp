#!/usr/bin/expect -f

set timeout 60
set kaspa_cli "../rusty-kaspa/target/release/kaspa-cli"
set master_mnemonic "arrest acid fall interest comfort expire aunt combine actor tackle stove coral"
set company_address "kaspatest:q44c975c89be50e8c6ec6b850d1100f8b05a5603ed2812661587ad81abd"
set event_hash "2663ab17173c8e2a69646c32c3b0b5187343363a9e40c07dd5725047dc071c2b1"

puts "🚀 MASTER → COMPANY WALLET TRANSACTION"
puts "======================================"
puts "From: Master Wallet"
puts "To: $company_address"  
puts "Event Hash: $event_hash"
puts ""

# Start kaspa-cli
spawn $kaspa_cli
expect "$ "

puts "📝 Importing master wallet..."
send "wallet import --testnet-10\r"

# Handle mnemonic entry
expect {
    "Enter mnemonic:" {
        send "$master_mnemonic\r"
    }
    "Create phishing hint" {
        send "\r"
        expect "Enter mnemonic:"
        send "$master_mnemonic\r"
    }
}

# Handle phishing hint prompt
expect {
    "Create phishing hint" {
        puts "Skipping phishing hint..."
        send "\r"
    }
    "$ " {
        # Already at prompt
    }
}

expect "$ "
puts "✅ Wallet imported successfully"

puts "💰 Checking master wallet balance..."
send "wallet balance --testnet-10\r"
expect "$ "

puts "📍 Getting master wallet address..."  
send "wallet address --testnet-10\r"
expect "$ "

puts "🚀 Sending 0.01 KAS from master wallet to company wallet..."
send "wallet send --testnet-10 --to $company_address --amount 0.01\r"

# Wait for transaction completion
expect {
    -re "Transaction.*(sent|submitted|completed)" {
        puts "✅ SUCCESS! Transaction submitted!"
        set success 1
    }
    -re "Transaction ID.*: (\\w+)" {
        puts "✅ SUCCESS! Transaction ID: $expect_out(1,string)"
        set success 1
    }
    -re "(Error|Failed|Invalid)" {
        puts "❌ Transaction failed: $expect_out(0,string)"
        set success 0
    }
    "$ " {
        puts "Transaction command completed"
        set success 1
    }
    timeout {
        puts "❌ Transaction timed out"
        set success 0
    }
}

expect "$ "

puts "Exiting kaspa-cli..."
send "exit\r"
expect eof

if {$success == 1} {
    puts ""
    puts "🎉 TRANSACTION COMPLETED!"
    puts "✅ Successfully sent 0.01 KAS from master wallet to company wallet"
    puts "📊 Master Address: kaspatest:qpxm5tpyg8p6z7f6hy9mtlwz2es03cqtavaldsctcdltmnz6yfz6gvurgpmem"
    puts "📊 Company Address: $company_address"
    puts "🔗 Event Hash: $event_hash"
    puts ""
    puts "🌐 Check the transaction on Kaspa Explorer:"
    puts "https://explorer-tn10.kaspa.org/addresses/$company_address"
} else {
    puts ""
    puts "❌ TRANSACTION FAILED"
    exit 1
} 