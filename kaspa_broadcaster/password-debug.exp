#!/usr/bin/expect -f

set timeout 60
set kaspa_cli "../rusty-kaspa/target/release/kaspa-cli"

log_user 1

puts "ğŸ” PASSWORD DEBUG TEST"
puts "====================="

set password "simple123"
puts "Using password: '$password'"
puts ""

spawn $kaspa_cli
expect "$ "

send "wallet create --testnet-10\r"

# Account title
expect "Default account title:"
send "password-debug\r"
puts "âœ… Account title sent"

# Phishing hint
expect "Create phishing hint (optional, press <enter> to skip):"
send "\r"
puts "âœ… Phishing hint skipped"

# First password - VERY CAREFUL
puts "ğŸ” Sending first password: '$password'"
expect "Enter wallet encryption password:"
send "$password\r"
puts "âœ… First password sent"

# Second password - VERY CAREFUL  
puts "ğŸ” Sending second password: '$password'"
expect "Re-enter wallet encryption password:"
send "$password\r"
puts "âœ… Second password sent"

# Check result
puts "â³ Waiting for result..."
expect {
    "Wallet created successfully" {
        puts "ğŸ‰ SUCCESS! Passwords matched!"
        set success 1
    }
    "wallet secrets do not match" {
        puts "âŒ FAILURE: Passwords don't match"
        puts "ğŸ”§ Issue with password handling"
        set success 0
    }
    -re "Your mnemonic phrase.*: (.+)" {
        set mnemonic [string trim $expect_out(1,string)]
        puts "ğŸ‰ SUCCESS! Mnemonic found: [string range $mnemonic 0 30]..."
        set success 1
    }
    "$ " {
        puts "âœ… Back at prompt - checking if wallet was created"
        set success 1
    }
    timeout {
        puts "â±ï¸  Timeout"
        set success 0
    }
}

if {$success == 1} {
    puts ""
    puts "ğŸ¯ Testing wallet address to confirm creation..."
    send "wallet address --testnet-10\r"
    
    expect {
        -re "(kaspatest:\[a-z0-9\]+)" {
            set address $expect_out(1,string)
            puts "âœ… WALLET CREATED! Address: $address"
        }
        -re "error" {
            puts "âŒ No wallet found - creation failed"
        }
        timeout {
            puts "âŒ No response to address command"
        }
    }
} else {
    puts "âŒ Password test failed"
}

send "exit\r"
expect eof

puts ""
puts "ğŸ” PASSWORD DEBUG COMPLETE" 