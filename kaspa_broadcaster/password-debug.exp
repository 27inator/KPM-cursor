#!/usr/bin/expect -f

set timeout 60
set kaspa_cli "../rusty-kaspa/target/release/kaspa-cli"

log_user 1

puts "🔐 PASSWORD DEBUG TEST"
puts "====================="

set password "simple123"
puts "Using password: '$password'"
puts ""

spawn $kaspa_cli
expect "$ "

send "wallet create --testnet-10\r"

# Account title
expect "Default account title:"
send "password-debug\r"
puts "✅ Account title sent"

# Phishing hint
expect "Create phishing hint (optional, press <enter> to skip):"
send "\r"
puts "✅ Phishing hint skipped"

# First password - VERY CAREFUL
puts "🔐 Sending first password: '$password'"
expect "Enter wallet encryption password:"
send "$password\r"
puts "✅ First password sent"

# Second password - VERY CAREFUL  
puts "🔐 Sending second password: '$password'"
expect "Re-enter wallet encryption password:"
send "$password\r"
puts "✅ Second password sent"

# Check result
puts "⏳ Waiting for result..."
expect {
    "Wallet created successfully" {
        puts "🎉 SUCCESS! Passwords matched!"
        set success 1
    }
    "wallet secrets do not match" {
        puts "❌ FAILURE: Passwords don't match"
        puts "🔧 Issue with password handling"
        set success 0
    }
    -re "Your mnemonic phrase.*: (.+)" {
        set mnemonic [string trim $expect_out(1,string)]
        puts "🎉 SUCCESS! Mnemonic found: [string range $mnemonic 0 30]..."
        set success 1
    }
    "$ " {
        puts "✅ Back at prompt - checking if wallet was created"
        set success 1
    }
    timeout {
        puts "⏱️  Timeout"
        set success 0
    }
}

if {$success == 1} {
    puts ""
    puts "🎯 Testing wallet address to confirm creation..."
    send "wallet address --testnet-10\r"
    
    expect {
        -re "(kaspatest:\[a-z0-9\]+)" {
            set address $expect_out(1,string)
            puts "✅ WALLET CREATED! Address: $address"
        }
        -re "error" {
            puts "❌ No wallet found - creation failed"
        }
        timeout {
            puts "❌ No response to address command"
        }
    }
} else {
    puts "❌ Password test failed"
}

send "exit\r"
expect eof

puts ""
puts "🔐 PASSWORD DEBUG COMPLETE" 