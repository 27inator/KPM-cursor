#!/usr/bin/expect -f

set timeout 60
set kaspa_cli "../rusty-kaspa/target/release/kaspa-cli"

log_user 1

puts "üîí FIXED TIMING WALLET CREATOR"
puts "=============================="

spawn $kaspa_cli
expect "$ "

puts "Starting wallet creation with longer timeout..."
send "wallet create --testnet-10\r"

# Give it much longer to respond
puts "Waiting up to 60 seconds for prompts..."
expect {
    "Default account title:" {
        puts "‚úÖ Got the account title prompt!"
        send "test-company-fixed\r"
        
        # Now wait for mnemonic
        expect {
            -re "(Mnemonic|mnemonic|phrase).*: (.+)" {
                set mnemonic [string trim $expect_out(2,string)]
                puts "‚úÖ Mnemonic captured: [string range $mnemonic 0 20]..."
            }
            timeout {
                puts "‚ùå No mnemonic after account title"
            }
        }
        
        # Handle phishing hint
        expect {
            "Create phishing hint" {
                puts "Skipping phishing hint..."
                send "\r"
            }
            "$ " {
                puts "At prompt"
            }
            timeout {
                puts "Continuing..."
            }
        }
        
        expect "$ "
        
        # Get address
        send "wallet address --testnet-10\r"
        expect {
            -re "(kaspatest:\[a-z0-9\]+)" {
                set address $expect_out(1,string)
                puts "‚úÖ Address: $address"
                puts "üåê Explorer: https://explorer-tn10.kaspa.org/addresses/$address"
            }
            timeout {
                puts "‚ùå No address"
            }
        }
        
        expect "$ "
        
        # Save result
        if {[info exists address] && [info exists mnemonic]} {
            set fp [open "fixed_wallet_result.txt" w]
            puts $fp "FIXED WALLET CREATION SUCCESS"
            puts $fp "============================"
            puts $fp "Company: test-company-fixed"
            puts $fp "Address: $address"
            puts $fp "Mnemonic: $mnemonic"
            puts $fp "Explorer: https://explorer-tn10.kaspa.org/addresses/$address"
            close $fp
            puts "üíæ Saved to fixed_wallet_result.txt"
        }
    }
    timeout {
        puts "‚ùå Still no account title prompt after 60 seconds"
        puts "Raw output so far:"
        expect {
            -re "(.+)" {
                puts "RAW: $expect_out(1,string)"
                exp_continue
            }
            timeout {
                puts "No more output"
            }
        }
    }
}

send "exit\r"
expect eof 