#!/usr/bin/expect -f

set timeout 60
set kaspa_cli "../rusty-kaspa/target/release/kaspa-cli"

log_user 1

puts "ğŸ” MNEMONIC CAPTURE FOCUS TEST"
puts "=============================="
puts "Specifically testing mnemonic output parsing"

spawn $kaspa_cli
expect "$ "

send "wallet create --testnet-10\r"

# Handle all the prompts first
expect "Default account title:"
send "mnemonic-test\r"
puts "âœ… Account title"

expect "Create phishing hint (optional, press <enter> to skip):"
send "\r"
puts "âœ… Phishing hint skipped"

expect "Enter wallet encryption password:"
send "testpass\r"
puts "âœ… Password sent"

# Look for password confirmation
expect {
    "Confirm wallet encryption password:" {
        send "testpass\r"
        puts "âœ… Password confirmed"
    }
    timeout {
        puts "âš ï¸  No confirmation prompt"
    }
}

puts ""
puts "ğŸ”‘ NOW FOCUSING ON MNEMONIC OUTPUT..."
puts "======================================"

# Capture EVERYTHING for 30 seconds and look for mnemonic patterns
set mnemonic_found 0
set start_time [clock seconds]

while {[expr [clock seconds] - $start_time] < 30 && $mnemonic_found == 0} {
    expect {
        -re "Your mnemonic phrase is: (.+)" {
            set mnemonic [string trim $expect_out(1,string)]
            puts "ğŸ¯ PATTERN 1 - 'Your mnemonic phrase is:' - FOUND!"
            puts "   Mnemonic: $mnemonic"
            set mnemonic_found 1
        }
        -re "Your mnemonic phrase: (.+)" {
            set mnemonic [string trim $expect_out(1,string)]
            puts "ğŸ¯ PATTERN 2 - 'Your mnemonic phrase:' - FOUND!"
            puts "   Mnemonic: $mnemonic"
            set mnemonic_found 1
        }
        -re "Mnemonic phrase: (.+)" {
            set mnemonic [string trim $expect_out(1,string)]
            puts "ğŸ¯ PATTERN 3 - 'Mnemonic phrase:' - FOUND!"
            puts "   Mnemonic: $mnemonic"
            set mnemonic_found 1
        }
        -re "mnemonic: (.+)" {
            set mnemonic [string trim $expect_out(1,string)]
            puts "ğŸ¯ PATTERN 4 - 'mnemonic:' - FOUND!"
            puts "   Mnemonic: $mnemonic"
            set mnemonic_found 1
        }
        -re "phrase: (.+)" {
            set mnemonic [string trim $expect_out(1,string)]
            puts "ğŸ¯ PATTERN 5 - 'phrase:' - FOUND!"
            puts "   Mnemonic: $mnemonic"
            set mnemonic_found 1
        }
        -re "\n(.+)\n" {
            set line [string trim $expect_out(1,string)]
            puts "LINE: '$line'"
            
            # Check if this line looks like a mnemonic (multiple words)
            set word_count [llength [split $line " "]]
            if {$word_count >= 12} {
                puts "ğŸ¯ POSSIBLE MNEMONIC LINE ($word_count words): $line"
                set mnemonic $line
                set mnemonic_found 1
            }
            
            # Continue looking
            if {$mnemonic_found == 0} {
                exp_continue
            }
        }
        -re "(.+)" {
            puts "OTHER: '$expect_out(1,string)'"
            exp_continue
        }
        "$ " {
            puts "ğŸ¯ COMMAND PROMPT REACHED"
            break
        }
        timeout {
            puts "â±ï¸  1 second timeout, continuing..."
            exp_continue
        }
    }
}

if {$mnemonic_found == 1} {
    puts ""
    puts "ğŸ‰ MNEMONIC CAPTURE SUCCESS!"
    puts "ğŸ“ Captured: [string range $mnemonic 0 50]..."
    puts "ğŸ“Š Length: [string length $mnemonic] characters"
    puts "ğŸ”¢ Words: [llength [split $mnemonic " "]]"
    
    # Save the result
    set fp [open "mnemonic_capture_success.txt" w]
    puts $fp "MNEMONIC CAPTURE SUCCESS"
    puts $fp "======================"
    puts $fp "Full mnemonic: $mnemonic"
    puts $fp "Length: [string length $mnemonic]"
    puts $fp "Word count: [llength [split $mnemonic " "]]"
    close $fp
    
    puts "ğŸ’¾ Saved to: mnemonic_capture_success.txt"
} else {
    puts ""
    puts "âŒ MNEMONIC CAPTURE FAILED"
    puts "ğŸ”§ Need to analyze the output patterns"
}

send "exit\r"
expect eof 